// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  accounts          Account[]
  sessions          Session[]
  onboardingProfile OnboardingProfile?
  portfolio         Portfolio?
  twoFactorAuth     TwoFactorAuth?
  trades            Trade[]

  @@map("user")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model TwoFactorAuth {
  id        String   @id @default(cuid())
  userId    String   @unique
  code      String   // The 2FA code/secret
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

model OnboardingProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  completed Boolean  @default(false)
  
  // Robinhood linking
  robinhoodEmail String?
  robinhoodLinked Boolean @default(false)
  
  // Investment preferences
  goal       String? // fast, steady, experiment, risk, balanced
  riskLevel  String? // low, medium, high
  period     Int?    // 6, 24, 48 months
  exclusions String? // JSON array of exclusions
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_profile")
}

model Portfolio {
  id        String   @id @default(cuid())
  userId    String   @unique

  // Current portfolio value
  currentValue Float @default(0)

  // Performance changes
  dayChangeValue       Float @default(0)
  dayChangePercentage  Float @default(0)

  weekChangeValue      Float @default(0)
  weekChangePercentage Float @default(0)

  monthChangeValue      Float @default(0)
  monthChangePercentage Float @default(0)

  threeMonthChangeValue      Float @default(0)
  threeMonthChangePercentage Float @default(0)

  yearChangeValue      Float @default(0)
  yearChangePercentage Float @default(0)

  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions Position[]

  @@map("portfolio")
}

model Position {
  id           String   @id @default(cuid())
  portfolioId  String

  // Position details
  symbol       String
  quantity     Float
  averagePrice Float
  currentPrice Float
  marketValue  Float

  // Performance
  totalReturn       Float
  totalReturnPercent Float
  dayReturn         Float
  dayReturnPercent  Float

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, symbol])
  @@map("position")
}

enum TradeAction {
  BUY
  SELL
}

enum TradeStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
}

model Trade {
  id        String      @id @default(cuid())
  userId    String

  // Trade details
  symbol    String      // Ticker symbol (e.g., AAPL, TSLA)
  amount    Float       // Number of shares
  action    TradeAction // BUY or SELL
  status    TradeStatus @default(PENDING)

  // Optional metadata
  price     Float?      // Price per share (optional)
  total     Float?      // Total value (optional)
  note      String?     // Optional note

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("trade")
}
